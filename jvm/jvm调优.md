# JVM调优



目的：降本增效。使应用程序用最小的硬件消耗来承载更大的吞吐量。

什么时候需要JVM调优？

- 系统吞吐量下降，或P90，P99响应增加
- 堆内存持续上涨，到出现OOM
- 频繁Full GC，GC停顿过长（>1s）
- 应用中有使用本地缓存且占用大量内存空间

调优需要做什么？

- 内存合理分配与使用，垃圾收集器的选配

调优的原则？

- 优先原则：产品，架构，代码，数据库优先，JVM是最后手段
- 观测性原则：发现问题解决问题，没问题不创造问题。

调优的目标？

- 堆内存使用率 <= 70%
- 老年代内存使用率 <= 70%
- avg pause <= 1s
- Full GC次数0 或 avg pause interval >= 24h
- 创建更多的线程









JVM调优主要步骤：

1. 监控JVM分析问题：评估必要性，内存使用，GC频率，GC耗时
2. 确定目标：内存占用，响应延迟
3. 制定方案：配置内存及GC相关参数
4. 验证方案：测试环境对比方案前后差异，确定是否生效
5. 结果验收：灰度测试，全量发布



## JVM参数

JVM调优典型参数设置：

- -Xms，-Xmx，-Xss
- -XX:+UseParallelGC，-XX:UseParallelOldGC
- -XX:+UseParNewGC，-XX:+UseConcMarkSweepGC
- -XX:+UseG1GC



**-Xms堆内存的最小值：**

默认情况下，当堆中可用内存小于40%时，堆内存会开始增加，一直增加到-Xmx。

**-Xmx堆内存的最大值：**

默认情况下，当堆中可用内存大于70%时，堆内存会开始减少，一直减少到-Xms。

**-Xmn新生代内存的最大值：**

包括Eden区和两个Survivor区的总和。

配置写法如：-Xmn1024k，-Xmn1024m，-Xmn1g

**-Xss每个线程的栈内存：**

默认1M，一般来说是不需要改，线程栈越小意味着可以创建的线程数越多
$$
系统最大可创建的线程数量=\frac {机器本身可用内存 - (JVM分配的堆内存 + JVM元数据区)}{Xss}
$$
整个堆大小=年轻代大小+老年代大小。增大了年轻代，老年代会减少。官方默认的配置为：
$$
\frac {老年代}{年轻代} = \frac {2}{1} 
$$














